# 日志设计

## 基础功能

### 日志包需要支持基本的日志信息

包括时间戳、文件名、行号、日志级别和日志信息。

### 支持不同的日志级别

![](<../../../.gitbook/assets/image (1) (2) (1).png>)

### 支持自定义配置

不同的运行环境，需要不同的日志输出配置

### 支持输出到标准输出和文件

输出到标准输出和保存到文件是一个日志包最基本的功能

## 高级功能

**支持多种日志格式**，至少支持text和json格式&#x20;

**能够按级别分类输出**，错误级别的日志可以输出到独立的文件中&#x20;

**支持结构化日志**，使用 JSON 或者其他编码方式使日志结构化&#x20;

**支持日志轮转**，确保日志大小达到一定量级时，对日志进行切割、压缩，并转存

## 设计日志包时需要关注的点

### 高性能

因为我们要在代码中频繁调用日志包，记录日志，所以日志包的性能是首先要考虑的点，一个性能很差的日志包必然会导致整个应用性能很差。

### 并发安全

Go 应用程序会大量使用 Go 语言的并发特性，也就意味着需要并发地记录日志，这就需要日志包是并发安全的。

### 插件化能力

日志包应该能提供一些插件化的能力，比如允许开发者自定义输出格式，自定义存储位置，自定义错误发生时的行为（例如 告警、发邮件等）。插件化的能力不是必需的，因为日志自身的特性就能满足绝大部分的使用需求，例如：输出格式支持 JSON 和 TEXT，存储位置支持标准输出和文件，日志监控可以通过一些旁路系统来实现。

### 日志参数控制

日志包应该能够灵活地进行配置，初始化时配置或者程序运行时配置。例如：初始化配置可以通过 Init 函数完成，运行时配置可以通过 SetOptions / SetLevel 等函数来完成。



## 如何记录日志

### 在何处打印日志？

#### **在分支语句处打印日志**

在分支语句处打印日志，可以判断出代码走了哪个分支，有助于判断请求的下一跳，继而继续排查问题。&#x20;

#### 写操作必须打印日志

写操作最可能会引起比较严重的业务故障，写操作打印日志，可以在出问题时找到关键信息。&#x20;

#### 在循环中打印日志要慎重

如果循环次数过多，会导致打印大量的日志，严重拖累代码的性能，建议的办法是在循环中记录要点，在循环外面总结打印出来。&#x20;

#### 在错误产生的最原始位置打印日志

对于嵌套的 Error，可在 Error 产生的最初位置打印 Error 日志，上层如果不需要添加必要的信息，可以直接返回下层的 Error。

### 在哪个日志级别打印日志？

![](<../../../.gitbook/assets/image (2).png>)

#### Debug 级别&#x20;

Debug 这个级别的日志可以随意输出，任何你觉得有助于开发、测试阶段调试的日志，都可以在这个级别打印。

#### Info 级别&#x20;

Info 级别的日志可以记录一些有用的信息，供以后的运营分析

#### Warn 级别

一些警告类的日志可以记录在 Warn 级别，Warn 级别的日志往往说明程序运行异常，不符合预期，但又不影响程序的继续运行，或者是暂时影响，但后续会恢复。Warn 更多的是业务级别的警告日志。

#### Error 级别&#x20;

Error 级别的日志告诉我们程序执行出错，这些错误肯定会影响到程序的执行结果，例如请求失败、创建资源失败等。要记录每一个发生错误的日志，避免日后排障过程中这些错误被忽略掉。大部分的错误可以归在 Error 级别。

#### Panic 级别&#x20;

Panic 级别的日志在实际开发中很少用，通常只在需要错误堆栈，或者不想因为发生严重错误导致程序退出，而采用 defer 处理错误时使用。

#### Fatal 级别&#x20;

Fatal 是最高级别的日志，这个级别的日志说明问题已经相当严重，严重到程序无法继续运行，通常是系统级的错误。



### 如何记录日志内容？

```
• 在记录日志时，不要输出一些敏感信息，例如密码、密钥等。
• 为了方便调试，通常会在 Debug 级别记录一些临时日志，这些日志内容可以用一些特殊的字符开头，例如 log.Debugf("XXXXXXXXXXXX-1:Input key was: %s", setKeyName) 。这样，在完成调试后，可以通过查找 XXXXXXXXXXXX 字符串，找到这些临时日志，在 commit 前删除。
• 日志内容应该小写字母开头，以英文点号 . 结尾，例如 log.Info("update user function called.") 。
• 为了提高性能，尽可能使用明确的类型，例如使用 log.Warnf("init datastore: %s", err.Error()) 而非 log.Warnf("init datastore: %v", err) 。
• 根据需要，日志最好包含两个信息。一个是请求 ID（RequestID），是每次请求的唯一 ID，便于从海量日志中过滤出某次请求的日志，可以将请求 ID 放在请求的通用日志字段中。另一个是用户和行为，用于标识谁做了什么。
• 不要将日志记录在错误的日志级别上。
```

## 优秀开源日志包使用教程

{% embed url="https://github.com/marmotedu/geekbang-go/blob/master/%E4%BC%98%E7%A7%80%E5%BC%80%E6%BA%90%E6%97%A5%E5%BF%97%E5%8C%85%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B.md" %}









